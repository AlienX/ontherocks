/*!
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2013, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license1.0.html Craft License
 * @link      http://buildwithcraft.com
 */
if(typeof Assets=="undefined"){Assets={}}Assets.OperationManager=Garnish.Base.extend({$startOperationsButton:null,$sourceMasterCheckbox:null,$sourceCheckboxes:null,$indexCheckbox:null,$transformsCheckbox:null,$transformMasterCheckbox:null,$transformCheckboxes:null,$progressBarContainer:null,sessionId:null,queue:null,modal:null,missingFolders:[],init:function(){this.$startOperationsButton=$("#start-operations");this.$sourceMasterCheckbox=$(".assets-sources input[type=checkbox].all");this.$sourceCheckboxes=$(".assets-sources input[type=checkbox]").not(".all");this.$indexCheckbox=$("#do-index");this.$transformsCheckbox=$("#do-transforms");this.$transformMasterCheckbox=$("#transforms input[type=checkbox].all");this.$transformCheckboxes=$("#transforms input[type=checkbox]").not(".all");this.$progressBarContainer=$(".operation-progress");this.$modalContainerDiv=null;this.addListener(this.$startOperationsButton,"click","startOperations")},startOperations:function(){if(this.$startOperationsButton.hasClass("disabled")){return}var d=[];if(this.$transformsCheckbox.prop("checked")){this.$transformCheckboxes.filter(":checked").each(function(){d.push($(this).val())})}var c=this.$indexCheckbox.prop("checked");var a=this.$sourceCheckboxes.filter(":checked");if(a.length==0||!(c||d.length)){this.$startOperationsButton.removeClass("disabled");return}var b={doIndexes:Number(c),transforms:d};this.$startOperationsButton.addClass("disabled");this.$sourceMasterCheckbox.prop("disabled",true);this.$sourceCheckboxes.prop("disabled",true);this.$transformMasterCheckbox.prop("disabled",true);this.$transformCheckboxes.prop("disabled",true);this.$indexCheckbox.prop("disabled",true);Craft.postActionRequest("assetOperations/getSessionId",$.proxy(function(f){this.sessionId=f.sessionId;this.missingFolders=[];this.queue=new AjaxQueueManager(10,this.displayIndexingReport,this);this.$progressBarContainer.empty();var e=this;a.each(function(){var i=$(this);var g=i.parent().text();var h=$('<div class="progress-bar"><label>'+g+"</label><span></span></div>").appendTo(e.$progressBarContainer);var j={sourceId:i.val(),session:e.sessionId,doIndexes:b.doIndexes,doTransforms:b.transforms};e.queue.addItem(Craft.getActionUrl("assetOperations/startIndex"),j,$.proxy(function(m){if(typeof m!="object"){i.prop("checked",false);alert(Craft.t("There was an error while indexing {source}: {message}",{source:g.trim(),message:m}));return}h.attr("total",m.total).attr("current",0);for(var l=0;l<m.total;l++){j={session:this.sessionId,sourceId:m.sourceId,offset:l,doIndexes:b.doIndexes,doTransforms:b.transforms};this.queue.addItem(Craft.getActionUrl("assetOperations/performIndex"),j,function(){h.attr("current",parseInt(h.attr("current"),10)+1);h.find(">span").html(h.attr("current")+" / "+h.attr("total"))})}if(typeof m.missingFolders!="undefined"){for(var k in m.missingFolders){this.missingFolders.push({folder_id:k,folder_name:m.missingFolders[k]})}}},e))});this.queue.startQueue()},this))},displayIndexingReport:function(){this.$startOperationsButton.removeClass("disabled");this.$progressBarContainer.html("");if(!this.$indexCheckbox.prop("checked")){this.releaseLock();return}var a=[];this.$sourceCheckboxes.filter(":checked").each(function(){a.push($(this).val())});if(this.$modalContainerDiv==null){this.$modalContainerDiv=$('<div class="modal index-report"></div>').addClass().appendTo(Garnish.$bod)}if(this.modal==null){this.modal=new Garnish.Modal();this.modal.sessionId=this.sessionId;this.modal.OperationManager=this}var b={sessionId:this.sessionId,command:JSON.stringify({command:"statistics"}),sources:a.join(",")};$.post(Craft.getActionUrl("assetOperations/finishIndex"),b,$.proxy(function(f){var d="";if(typeof f.files!="undefined"||this.missingFolders.length>0){d+='<div class="body"><p>'+Craft.t("The following items were found in the database that do not have a physical match.")+"</p>";if(this.missingFolders.length>0){d+='<div class="report-part"><strong>'+Craft.t("Folders")+"</strong>";for(var c=0;c<this.missingFolders.length;c++){d+='<div><label><input type="checkbox" checked="checked" class="delete_folder" value="'+this.missingFolders[c].folder_id+'" /> '+this.missingFolders[c].folder_name+"</label></div>"}d+="</div>"}if(typeof f.files!="undefined"){d+='<div class="report-part"><strong>'+Craft.t("Files")+"</strong>";for(var e in f.files){d+='<div><label><input type="checkbox" checked="checked" class="delete_file" value="'+e+'" /> '+f.files[e]+"</label></div>"}d+="</div>"}d+="</div>";d+='<footer class="footer"><ul class="right">';d+='<li><input type="button" class="btn cancel" value="'+Craft.t("Cancel")+'"></li>';d+='<li><input type="button" class="btn submit delete" value="'+Craft.t("Delete")+'"></li>';d+="</ul></footer>";this.$modalContainerDiv.empty().append(d);this.modal.setContainer(this.$modalContainerDiv);this.modal.show();this.modal.removeListener(Garnish.Modal.$shade,"click");this.modal.addListener(this.modal.$container.find(".btn.cancel"),"click",function(){this.OperationManager.releaseLock();this.hide()});this.modal.addListener(this.modal.$container.find(".btn.delete"),"click",function(){var i={};i.command="delete";i.folderIds=[];i.fileIds=[];this.$container.find("input.delete_folder:checked").each(function(){i.folderIds.push($(this).val())});this.$container.find("input.delete_file:checked").each(function(){i.fileIds.push($(this).val())});var g=[];this.OperationManager.$sourceCheckboxes.filter(":checked").each(function(){g.push($(this).val())});var h={sessionId:this.sessionId,command:JSON.stringify(i),sources:g.join(",")};$.post(Craft.getActionUrl("assetOperations/finishIndex"),h,$.proxy(function(j){this.hide();this.OperationManager.releaseLock()},this))})}else{this.releaseLock()}},this))},releaseLock:function(){this.$sourceMasterCheckbox.prop("disabled",false);if(this.$sourceMasterCheckbox.prop("checked")){this.$sourceMasterCheckbox.prop("disabled",false)}else{this.$sourceCheckboxes.prop("disabled",false)}this.$transformMasterCheckbox.prop("disabled",false);if(this.$transformMasterCheckbox.prop("checked")){this.$transformMasterCheckbox.prop("disabled",false)}else{this.$transformCheckboxes.prop("disabled",false)}this.$indexCheckbox.prop("disabled",false)}});new Assets.OperationManager();