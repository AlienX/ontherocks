/*!
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2013, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license1.0.html Craft License
 * @link      http://buildwithcraft.com
 */
if(typeof Assets=="undefined"){Assets={}}Assets.IndexingManager=Garnish.Base.extend({$startOperationsButton:null,$sourceMasterCheckbox:null,$sourceCheckboxes:null,$indexCheckbox:null,$transformsCheckbox:null,$transformMasterCheckbox:null,$transformCheckboxes:null,$progressBarContainer:null,sessionId:null,queue:null,modal:null,missingFolders:[],init:function(){this.$startOperationsButton=$("#start-operations");this.$sourceMasterCheckbox=$(".assets-sources input[type=checkbox].all");this.$sourceCheckboxes=$(".assets-sources input[type=checkbox]").not(".all");this.$progressBarContainer=$(".operation-progress");this.$modalContainerDiv=null;this.addListener(this.$startOperationsButton,"click","startOperations")},startOperations:function(){if(this.$startOperationsButton.hasClass("disabled")){return}var a=this.$sourceCheckboxes.filter(":checked");if(a.length==0){this.$startOperationsButton.removeClass("disabled");return}this.$startOperationsButton.addClass("disabled");this.$sourceMasterCheckbox.prop("disabled",true);this.$sourceCheckboxes.prop("disabled",true);Craft.postActionRequest("assetIndexing/getSessionId",$.proxy(function(c){this.sessionId=c.sessionId;this.missingFolders=[];this.queue=new AjaxQueueManager(10,this.displayIndexingReport,this);this.$progressBarContainer.empty();var b=this;a.each(function(){var f=$(this);var d=f.parent().text();var e=$('<div class="progress-bar"><label>'+d+"</label><span></span></div>").appendTo(b.$progressBarContainer);var g={sourceId:f.val(),session:b.sessionId};b.queue.addItem(Craft.getActionUrl("assetIndexing/startIndex"),g,$.proxy(function(k){if(typeof k!="object"){f.prop("checked",false);alert(Craft.t("There was an error while indexing {source}: {message}",{source:d.trim(),message:k}));return}e.attr("total",k.total).attr("current",0);for(var j=0;j<k.total;j++){g={session:this.sessionId,sourceId:k.sourceId,offset:j};this.queue.addItem(Craft.getActionUrl("assetIndexing/performIndex"),g,function(){e.attr("current",parseInt(e.attr("current"),10)+1);e.find(">span").html(e.attr("current")+" / "+e.attr("total"))})}if(typeof k.missingFolders!="undefined"){for(var h in k.missingFolders){this.missingFolders.push({folder_id:h,folder_name:k.missingFolders[h]})}}},b))});this.queue.startQueue()},this))},displayIndexingReport:function(){this.$startOperationsButton.removeClass("disabled");this.$progressBarContainer.html("");var a=[];this.$sourceCheckboxes.filter(":checked").each(function(){a.push($(this).val())});var b={sessionId:this.sessionId,command:JSON.stringify({command:"statistics"}),sources:a.join(",")};$.post(Craft.getActionUrl("assetIndexing/finishIndex"),b,$.proxy(function(f){var d="";if(typeof f.files!="undefined"||this.missingFolders.length>0){if(this.$modalContainerDiv==null){this.$modalContainerDiv=$('<div class="modal index-report"></div>').addClass().appendTo(Garnish.$bod)}if(this.modal==null){this.modal=new Garnish.Modal();this.modal.sessionId=this.sessionId;this.modal.OperationManager=this;this.modal.hide()}d+='<div class="body"><p>'+Craft.t("The following items were found in the database that do not have a physical match.")+"</p>";if(this.missingFolders.length>0){d+='<div class="report-part"><strong>'+Craft.t("Folders")+"</strong>";for(var c=0;c<this.missingFolders.length;c++){d+='<div><label><input type="checkbox" checked="checked" class="delete_folder" value="'+this.missingFolders[c].folder_id+'" /> '+this.missingFolders[c].folder_name+"</label></div>"}d+="</div>"}if(typeof f.files!="undefined"){d+='<div class="report-part"><strong>'+Craft.t("Files")+"</strong>";for(var e in f.files){d+='<div><label><input type="checkbox" checked="checked" class="delete_file" value="'+e+'" /> '+f.files[e]+"</label></div>"}d+="</div>"}d+="</div>";d+='<footer class="footer"><ul class="right">';d+='<li><input type="button" class="btn cancel" value="'+Craft.t("Cancel")+'"></li>';d+='<li><input type="button" class="btn submit delete" value="'+Craft.t("Delete")+'"></li>';d+="</ul></footer>";this.$modalContainerDiv.empty().append(d);this.modal.setContainer(this.$modalContainerDiv);this.modal.show();this.modal.removeListener(Garnish.Modal.$shade,"click");this.modal.addListener(this.modal.$container.find(".btn.cancel"),"click",function(){this.OperationManager.releaseLock();this.hide()});this.modal.addListener(this.modal.$container.find(".btn.delete"),"click",function(){var i={};i.command="delete";i.folderIds=[];i.fileIds=[];this.$container.find("input.delete_folder:checked").each(function(){i.folderIds.push($(this).val())});this.$container.find("input.delete_file:checked").each(function(){i.fileIds.push($(this).val())});var g=[];this.OperationManager.$sourceCheckboxes.filter(":checked").each(function(){g.push($(this).val())});var h={sessionId:this.sessionId,command:JSON.stringify(i),sources:g.join(",")};$.post(Craft.getActionUrl("assetIndexing/finishIndex"),h,$.proxy(function(j){this.hide();this.OperationManager.releaseLock()},this))})}else{this.releaseLock()}},this))},releaseLock:function(){this.$sourceMasterCheckbox.prop("disabled",false);if(this.$sourceMasterCheckbox.prop("checked")){this.$sourceMasterCheckbox.prop("disabled",false)}else{this.$sourceCheckboxes.prop("disabled",false)}}});new Assets.IndexingManager();