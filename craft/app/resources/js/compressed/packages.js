/*!
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2013, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license1.0.html Craft License
 * @link      http://buildwithcraft.com
 */
(function(a){Craft.PackageChooser=Garnish.Base.extend({settings:null,$container:null,grid:null,packages:null,clearCcModalTimeout:null,ccModal:null,$ccModalHeader:null,$ccModalSecure:null,$ccModalError:null,$ccModalCancelBtn:null,$ccModalSubmitBtn:null,$ccModalSpinner:null,init:function(e){this.setSettings(e);this.$container=a("#packages");this.grid=new Craft.Grid(this.$container,{minColWidth:175,percentageWidths:false,fillMode:"grid"});this.packages={};for(var d=0;d<this.grid.$items.length;d++){var b=a(this.grid.$items[d]),f=b.find("h2:first"),c=b.data("package");this.packages[c]={pkg:c,name:f.text(),$container:b,$heading:f,$btnContainer:b.children(".buttons")}}Craft.postActionRequest("app/fetchPackageInfo",a.proxy(this,"initPackages"),a.proxy(this,"handleBadFetchPackageInfoResponse"))},initPackages:function(b){if(!b.success){this.handleBadFetchPackageInfoResponse(b.error);return}this.pkgInfo=b.packages;for(var c in this.packages){if(typeof b.packages[c]!="undefined"){a.extend(this.packages[c],b.packages[c])}this.createButtons(c)}},handleBadFetchPackageInfoResponse:function(b){for(var c in this.packages){this.packages[c].$btnContainer.children().css("visibility","hidden")}if(!b){b=Craft.t("An unknown error occurred.")}alert(b)},createButtons:function(i){var c=this.packages[i];if(c.$badge){c.$badge.remove();delete c.$badge}c.$btnContainer.html("");if(!c.price){return}if(c.licensed){if(Craft.hasPackage(i)){c.$badge=a('<div class="badge installed">'+Craft.t("Installed!")+"</div>")}else{c.$badge=a('<div class="badge uninstalled">'+Craft.t("Uninstalled")+"</div>")}}else{if(Craft.hasPackage(i)){c.$badge=a('<div class="badge unlicensed">'+Craft.t("Unlicensed")+"</div>")}if(c.salePrice){var e='<del class="light">'+this.formatPrice(c.price)+"</del> "+this.formatPrice(c.salePrice)}else{var e=this.formatPrice(c.price)}var d=a('<div class="btn buy">'+e+"<span>"+Craft.t("Buy")+"</span></a>").appendTo(c.$btnContainer);this.addListener(d,"activate",{pkg:i},"purchasePackage")}if(c.$badge){c.$badge.insertBefore(c.$heading)}if(c.licensed||Craft.hasPackage(i)){var k=a('<div class="btn menubtn settings icon"/>').appendTo(c.$btnContainer),b=a('<div class="menu"/>').appendTo(c.$btnContainer),h=a("<ul/>").appendTo(b),j=a("<li/>").appendTo(h);if(Craft.hasPackage(i)){var l=Craft.t("Uninstall"),g="uninstall"}else{var l=Craft.t("Install"),g="install"}var f=a("<a>"+l+"</a>").appendTo(j).data("package",i).data("action",g);new Garnish.MenuBtn(k,{onOptionSelect:a.proxy(this,"onOptionSelect")})}},purchasePackage:function(d){var c=d.data.pkg;if(!this.ccModal){var b=a(this.settings.modalHtml).appendTo(document.body);this.ccModal=new Garnish.Modal(b,{onShow:a.proxy(this,"onCcModalShow"),onHide:a.proxy(this,"onCcModalHide")});this.$ccModalHeader=b.find("h1:first");this.$ccModalSecure=b.find(".secure:first");this.$ccModalCancelBtn=b.find(".btn.cancel:first");this.$ccModalSubmitBtn=b.find(".btn.submit:first");this.$ccModalSpinner=b.find(".spinner:first");this.addListener(this.$ccModalCancelBtn,"activate",function(){this.ccModal.hide()})}else{this.removeListener(this.ccModal.$container,"submit");this.cleanupCcModal();this.ccModal.show()}var e=Craft.t("Purchase {package}",{"package":"<em>"+this.packages[c].name+"</em>"});this.$ccModalHeader.html(e);this.addListener(this.ccModal.$container,"submit",{pkg:c},"submitPackagePurchase");if(!Garnish.isMobileBrowser(true)){setTimeout(function(){a("#cc-name").focus()},500)}},cleanupCcModal:function(){this.ccModal.$container.find(".error").removeClass("error");if(this.$ccModalError){this.$ccModalError.remove()}},submitPackagePurchase:function(e){e.preventDefault();this.cleanupCcModal();var b=e.data.pkg;var d={name:a("#cc-name").val(),number:a("#cc-num").val(),exp_month:a("#cc-month").val(),exp_year:a("#cc-year").val(),cvc:a("#cc-cvc").val()};var c=true;if(!d.name){c=false;a("#cc-name").addClass("error")}if(!Stripe.validateCardNumber(d.number)){c=false;a("#cc-num").addClass("error")}if(!Stripe.validateExpiry(d.exp_month,d.exp_year)){c=false;a("#cc-month").addClass("error");a("#cc-year").addClass("error")}if(!Stripe.validateCVC(d.cvc)){c=false;a("#cc-cvc").addClass("error")}if(c){this.$ccModalSubmitBtn.addClass("active");this.$ccModalSpinner.removeClass("hidden");Stripe.setPublishableKey(this.settings.stripeApiKey);Stripe.createToken(d,a.proxy(function(f,g){if(!g.error){var h={ccTokenId:g.id,"package":b,expectedPrice:(this.packages[b].salePrice?this.packages[b].salePrice:this.packages[b].price)};Craft.postActionRequest("app/purchasePackage",h,a.proxy(this,"handleSuccessfulPurchase"),a.proxy(this,"handleUnsuccessfulPurchase"))}else{this.onPurchaseResponse();Garnish.shake(this.ccModal.$container)}},this))}else{Garnish.shake(this.ccModal.$container)}},onPurchaseResponse:function(){this.$ccModalSubmitBtn.removeClass("active");this.$ccModalSpinner.addClass("hidden")},handleSuccessfulPurchase:function(b){if(!b.success){this.handleUnsuccessfulPurchase(b.errors);return}var c=b["package"];this.packages[c].licensed=true;if(!Craft.hasPackage(c)){Craft.packages.push(c)}this.onPurchaseResponse();this.ccModal.hide();this.createButtons(c);Craft.cp.displayNotice(Craft.t("{package} purchased successfully!",{"package":this.packages[c].name}))},handleUnsuccessfulPurchase:function(e){this.onPurchaseResponse();if(e){var b="";for(var d in e){for(var c=0;c<e[d].length;c++){if(b){b+="<br>"}b+=e[d][c]}}this.$ccModalError=a('<p class="error centeralign">'+b+"</p>").insertBefore(this.$ccModalSecure)}Garnish.shake(this.ccModal.$container)},onCcModalShow:function(){if(this.clearCcModalTimeout){clearTimeout(this.clearCcModalTimeout)}},onCcModalHide:function(){this.clearCcModalTimeout=setTimeout(a.proxy(function(){a("#cc-name").val("");a("#cc-num").val("");a("#cc-month").val("");a("#cc-year").val("");a("#cc-cvc").val("")},this),Craft.PackageChooser.clearCcModalTimeoutDuration)},onOptionSelect:function(c){var e=a(c),b=e.data("package"),d=e.data("action");this.performPackageAction(b,d)},performPackageAction:function(c,e,f){var b=this.packages[c].$btnContainer;var d={"package":c};Craft.postActionRequest("app/"+e+"Package",d,a.proxy(function(g){if(!g.success){if(g.error){alert(g.error)}else{alert(Craft.t("An unknown error occurred."))}return}switch(e){case"install":Craft.packages.push(c);break;case"uninstall":var h=a.inArray(c,Craft.packages);Craft.packages.splice(h,1);break}this.createButtons(c);if(typeof f=="function"){f()}},this))},formatPrice:function(d){var c=this.settings.USD+Math.floor(d/100),b=d%100;if(b){b=b.toString();while(b.length<2){b+="0"}c+="."+b}return c}},{clearCcModalTimeoutDuration:30000})})(jQuery);